<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EAG Karneval</title>
  <link rel="icon" type="image/svg+xml" href="assets/favicon.svg" />
  <link rel="stylesheet" href="css/style.css" type="text/css" media="screen" />
  <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
  <script type="text/javascript" src="src/jquery.slotmachine.js"></script>
</head>

<body>
  <div class="loading-overlay" id="loadingOverlay" aria-live="polite" aria-busy="true">
    <div class="loading-card">
      <span class="spinner"></span>
      <p class="loading-text">Bilder werden geladen ‚Ä¶</p>
    </div>
  </div>
  <div class="page">
    <header class="hero">
      <div>
        <h1>EAG Karneval</h1>
        <p class="subhead">20 Jahre Karnevalistische Intelligenz [KI]</p>
      </div>
      <div class="status">
        <span class="status-label">Status</span>
        <span class="status-pill active">üç∫</span>
        <div class="status-user">
          <span class="status-name">EAG</span>
          <a class="btn btn-ghost btn-compact" href="#slot-machine">Motto-Lotto</a>
        </div>
      </div>
    </header>

    <main class="grid">
      <section id="slot-machine" class="panel slot-panel">
        <div class="panel-header">
          <h2>Motto-Lotto</h2>
          <p>Yeah Baby!</p>
        </div>

        <a id="year-anchor"></a>

        <div class="slot-machine" aria-label="Motto-Lotto">
          <div id="textMachine1" class="slot-reel">
            <div><img src="images/360/image_01-360.jpg" srcset="images/360/image_01-360.jpg 360w, images/720/image_01-720.jpg 720w" sizes="(max-width: 820px) 30vw, 33vw" alt="Motto 01" /></div>
            <div><img src="images/360/image_02-360.jpg" srcset="images/360/image_02-360.jpg 360w, images/720/image_02-720.jpg 720w" sizes="(max-width: 820px) 30vw, 33vw" alt="Motto 02" /></div>
            <div><img src="images/360/image_03-360.jpg" srcset="images/360/image_03-360.jpg 360w, images/720/image_03-720.jpg 720w" sizes="(max-width: 820px) 30vw, 33vw" alt="Motto 03" /></div>
            <div><img src="images/360/image_04-360.jpg" srcset="images/360/image_04-360.jpg 360w, images/720/image_04-720.jpg 720w" sizes="(max-width: 820px) 30vw, 33vw" alt="Motto 04" /></div>
            <div><img src="images/360/image_05-360.jpg" srcset="images/360/image_05-360.jpg 360w, images/720/image_05-720.jpg 720w" sizes="(max-width: 820px) 30vw, 33vw" alt="Motto 05" /></div>
            <div><img src="images/360/image_06-360.jpg" srcset="images/360/image_06-360.jpg 360w, images/720/image_06-720.jpg 720w" sizes="(max-width: 820px) 30vw, 33vw" alt="Motto 06" /></div>
            <div><img src="images/360/image_07-360.jpg" srcset="images/360/image_07-360.jpg 360w, images/720/image_07-720.jpg 720w" sizes="(max-width: 820px) 30vw, 33vw" alt="Motto 07" /></div>
          </div>
          <div id="textMachine2" class="slot-reel">
            <div><img src="images/360/image_08-360.jpg" srcset="images/360/image_08-360.jpg 360w, images/720/image_08-720.jpg 720w" sizes="(max-width: 820px) 30vw, 33vw" alt="Motto 08" /></div>
            <div><img src="images/360/image_09-360.jpg" srcset="images/360/image_09-360.jpg 360w, images/720/image_09-720.jpg 720w" sizes="(max-width: 820px) 30vw, 33vw" alt="Motto 09" /></div>
            <div><img src="images/360/image_10-360.jpg" srcset="images/360/image_10-360.jpg 360w, images/720/image_10-720.jpg 720w" sizes="(max-width: 820px) 30vw, 33vw" alt="Motto 10" /></div>
            <div><img src="images/360/image_11-360.jpg" srcset="images/360/image_11-360.jpg 360w, images/720/image_11-720.jpg 720w" sizes="(max-width: 820px) 30vw, 33vw" alt="Motto 11" /></div>
            <div><img src="images/360/image_12-360.jpg" srcset="images/360/image_12-360.jpg 360w, images/720/image_12-720.jpg 720w" sizes="(max-width: 820px) 30vw, 33vw" alt="Motto 12" /></div>
            <div><img src="images/360/image_13-360.jpg" srcset="images/360/image_13-360.jpg 360w, images/720/image_13-720.jpg 720w" sizes="(max-width: 820px) 30vw, 33vw" alt="Motto 13" /></div>
            <div><img src="images/360/image_14-360.jpg" srcset="images/360/image_14-360.jpg 360w, images/720/image_14-720.jpg 720w" sizes="(max-width: 820px) 30vw, 33vw" alt="Motto 14" /></div>
          </div>
          <div id="textMachine3" class="slot-reel">
            <div><img src="images/360/image_15-360.jpg" srcset="images/360/image_15-360.jpg 360w, images/720/image_15-720.jpg 720w" sizes="(max-width: 820px) 30vw, 33vw" alt="Motto 15" /></div>
            <div><img src="images/360/image_16-360.jpg" srcset="images/360/image_16-360.jpg 360w, images/720/image_16-720.jpg 720w" sizes="(max-width: 820px) 30vw, 33vw" alt="Motto 16" /></div>
            <div><img src="images/360/image_17-360.jpg" srcset="images/360/image_17-360.jpg 360w, images/720/image_17-720.jpg 720w" sizes="(max-width: 820px) 30vw, 33vw" alt="Motto 17" /></div>
            <div><img src="images/360/image_18-360.jpg" srcset="images/360/image_18-360.jpg 360w, images/720/image_18-720.jpg 720w" sizes="(max-width: 820px) 30vw, 33vw" alt="Motto 18" /></div>
            <div><img src="images/360/image_19-360.jpg" srcset="images/360/image_19-360.jpg 360w, images/720/image_19-720.jpg 720w" sizes="(max-width: 820px) 30vw, 33vw" alt="Motto 19" /></div>
            <div><img src="images/360/image_20-360.jpg" srcset="images/360/image_20-360.jpg 360w, images/720/image_20-720.jpg 720w" sizes="(max-width: 820px) 30vw, 33vw" alt="Motto 20" /></div>
          </div>
        </div>

        <div class="slot-actions">
          <button class="btn btn-primary slotMachineButton" id="slotMachineButtonShuffle" type="button">
            Lues g√§ets
          </button>
          <button class="btn btn-ghost slotMachineButton" id="slotMachineButtonStop" type="button">
            Stop
          </button>
        </div>

        <div class="slot-meta">
          <a id="resultLink" class="btn btn-ghost btn-compact" href="" role="button">Link teilen</a>
          <a id="infoButton" class="btn btn-ghost btn-compact" href="" role="button">Info</a>
        </div>

        <p class="hint">Tipp: Mit dem Share-Link kannst du das Ergebnis direkt teilen.</p>
      </section>
    </main>
  </div>

  <script>
    function getUrlParameter(sParam) {
      var sPageURL = window.location.search.substring(1);
      var sURLVariables = sPageURL.split('&');
      for (var i = 0; i < sURLVariables.length; i++) {
        var sParameterName = sURLVariables[i].split('=');
        if (sParameterName[0] == sParam) {
          return sParameterName[1];
        }
      }
    }

    function getBaseUrl() {
      var baseUrl;

      // IE does not support window.location.origin
      if (!window.location.origin) {
        baseUrl = window.location.protocol + "//" + window.location.hostname;
      }
      else {
        baseUrl = window.location.origin + window.location.pathname;
      }

      return baseUrl;
    }

    function _initWebAudio(AudioContext, format, audios, callback) {
      // See more details in http://www.html5rocks.com/en/tutorials/webaudio/intro/
      var context = new AudioContext();

      function _preload(asset) {
        var request = new XMLHttpRequest();
        request.open('GET', 'audio/' + asset.id + '.' + format, true);
        request.responseType = 'arraybuffer';

        request.onload = function () {
          context.decodeAudioData(request.response, function (buffer) {
            asset.play = function () {
              var source = context.createBufferSource(); // creates a sound source
              source.buffer = buffer;                    // tell the source which sound to play
              source.connect(context.destination);       // connect the source to the context's destination (the speakers)

              // play the source now
              // support both webkitAudioContext or standard AudioContext
              source.noteOn ? source.noteOn(0) : source.start(0);
            };
            // default volume
            // support both webkitAudioContext or standard AudioContext
            asset.gain = context.createGain ? context.createGain() : context.createGainNode();
            asset.gain.connect(context.destination);
            asset.gain.gain.value = 0.5;

            _check();
          }, function (err) {
            asset.play = function () {
            };
            _check(err, asset.id);
          });
        };
        request.onerror = function (err) {
          asset.play = function () {
          };
          _check(err, asset.id);
        };
        // kick off load
        request.send();
      }

      var loadc = 0;
      function _check(err, id) {
        if (err) {
          alert('Failed to load ' + id + '.' + format);
        }
        loadc++;
        if (audios.length == loadc) callback();
      }

      audios.forEach(function (asset) {
        _preload(asset);
      });
    }

    function _initHTML5Audio(format, audios, callback) {
      function _preload(asset) {
        asset.audio = new Audio('audio/' + asset.id + '.' + format);
        asset.audio.preload = 'auto';
        asset.audio.addEventListener("loadeddata", function () {
          // Loaded ok, set play function in object and set default volume
          asset.play = function () {
            asset.audio.play();
          };
          asset.audio.volume = 0.6;

          _check();
        }, false);

        asset.audio.addEventListener("error", function (err) {
          // Failed to load, set dummy play function
          asset.play = function () {
          }; // dummy

          _check(err, asset.id);
        }, false);
      }

      var loadc = 0;
      function _check(err, id) {
        if (err) {
          alert('Failed to load ' + id + '.' + format);
        }
        loadc++;
        if (audios.length == loadc) callback();
      }

      audios.forEach(function (asset) {
        _preload(asset);
      });
    }

    function initAudio(audios, callback) {
      if (window.AudioContext || window.webkitAudioContext) {
        // WebAudio API supported, create audio context
        var AudioContext = window.AudioContext ? window.AudioContext : window.webkitAudioContext;

        // init web audio
        // http://updates.html5rocks.com/2012/12/HTML5-audio-and-the-Web-Audio-API-are-BFFs
        return _initWebAudio(AudioContext, 'mp3', audios, callback);
      } else if (typeof Audio !== 'undefined') {
        // HTML5 audio supported
        // http://www.whatwg.org/specs/web-apps/current-work/multipage/the-video-element.html#the-audio-element
        return _initHTML5Audio('mp3', audios, callback);
      } else {
        console.log('Audio NOT Supported');
        // audio not supported
        audios.forEach(function (item) {
          item.play = function () {
          }; // dummy play
        });
        callback();
      }
    }

    function getRandomSlotIndex(elementsInSlot, randomValue) {
      var result = randomValue * elementsInSlot;
      result = Math.round(result) - 1;
      return result;
    }

    var p_slot1 = getUrlParameter("slot1");
    var p_slot2 = getUrlParameter("slot2");
    var p_slot3 = getUrlParameter("slot3");

    var p_autoplay = getUrlParameter("autoplay");
    p_autoplay = p_autoplay ? p_autoplay : "0";

    var p_sound = getUrlParameter("sound");
    p_sound = p_sound ? p_sound : "1";

    var PLAY_INTERVAL = 13500;
    var RUN_INTERVAL = 5000;

    function waitForSlotImages() {
      var images = document.querySelectorAll('.slot-machine img');
      if (!images.length) {
        return Promise.resolve();
      }

      return new Promise(function (resolve) {
        var remaining = images.length;

        function done() {
          remaining -= 1;
          if (remaining <= 0) {
            resolve();
          }
        }

        images.forEach(function (img) {
          if (img.complete && img.naturalWidth !== 0) {
            done();
            return;
          }
          img.addEventListener('load', done, { once: true });
          img.addEventListener('error', done, { once: true });
        });
      });
    }

    function initSlotMachine() {
      var audios = [
        { id: 'roll' }, // Played on roll tart
        { id: 'slot' }, // Played when reel stops
        { id: 'win' },  // Played on win
        { id: 'nowin' }  // Played on loss
      ];

      initAudio(audios, function () {
        // currently nothing to do
      });

      var elementsSlot1 = $("#textMachine1").children().length;
      var elementsSlot2 = $("#textMachine2").children().length;
      var elementsSlot3 = $("#textMachine3").children().length;

      var active_slot1 = Number.isFinite(parseInt(p_slot1, 10))
        ? parseInt(p_slot1, 10)
        : Math.floor(Math.random() * elementsSlot1);
      var active_slot2 = Number.isFinite(parseInt(p_slot2, 10))
        ? parseInt(p_slot2, 10)
        : Math.floor(Math.random() * elementsSlot2);
      var active_slot3 = Number.isFinite(parseInt(p_slot3, 10))
        ? parseInt(p_slot3, 10)
        : Math.floor(Math.random() * elementsSlot3);

      var machine1 = $("#textMachine1").slotMachine({
        active: active_slot1,
        delay: 800,
        randomize: function (activeElementIndex) {
          var result = getRandomSlotIndex(elementsSlot1, Math.random());
          return result;
        }
      });

      var machine2 = $("#textMachine2").slotMachine({
        active: active_slot2,
        delay: 1100,
        randomize: function (activeElementIndex) {
          var result = getRandomSlotIndex(elementsSlot2, Math.random());
          return result;
        }
      });

      var machine3 = $("#textMachine3").slotMachine({
        active: active_slot3,
        delay: 1400,
        randomize: function (activeElementIndex) {
          var result = getRandomSlotIndex(elementsSlot3, Math.random());
          return result;
        }
      });

      $("#slotMachineButtonShuffle").click(function () {
        machine1.shuffle();
        machine2.shuffle();
        machine3.shuffle();

        if (p_sound === "1") {
          audios[0].play();
        }
      });

      $("#slotMachineButtonStop").click(function () {
        machine1.stop();
        machine2.stop();
        machine3.stop();

        if (p_sound === "1") {
          audios[2].play();
        }
      });

      if (p_autoplay === "1") {
        setInterval(function () {
          machine1.shuffle();
          machine2.shuffle();
          machine3.shuffle();

          if (p_sound === "1") {
            audios[0].play();
          }

          setTimeout(function () {
            machine1.stop();
            machine2.stop();
            machine3.stop();

            if (p_sound === "1") {
              audios[2].play();
            }
          }, RUN_INTERVAL);
        }, PLAY_INTERVAL);
      }

      $("#resultLink").click(function () {
        alert("Der Motto-Link wurde aktualisiert und kann jetzt geteilt werden");

        var baseUrl = getBaseUrl();
        var params = "?slot1=" + machine1.active + "&slot2=" + machine2.active + "&slot3=" + machine3.active + "#year-anchor";

        $("#resultLink").attr("href", baseUrl + params);
      });

      $("#infoButton").click(function () {
        alert("Halts Mull un pf√ºff!");

        var baseUrl = getBaseUrl();
        var params = "?slot1=" + machine1.active + "&slot2=" + machine2.active + "&slot3=" + machine3.active + "#year-anchor";

        $("#infoButton").attr("href", baseUrl + params);
      });
    }

    $(function () {
      var overlay = document.getElementById('loadingOverlay');
      waitForSlotImages().then(function () {
        if (overlay) {
          overlay.classList.add('loading-overlay--hidden');
          setTimeout(function () {
            overlay.remove();
          }, 300);
        }
        initSlotMachine();
      });
    });
  </script>
  <script>
    (function (i, s, o, g, r, a, m) {
      i['GoogleAnalyticsObject'] = r; i[r] = i[r] || function () {
        (i[r].q = i[r].q || []).push(arguments)
      }, i[r].l = 1 * new Date(); a = s.createElement(o),
        m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g; m.parentNode.insertBefore(a, m)
    })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');

    ga('create', 'UA-59302336-1', 'auto');
    ga('send', 'pageview');
  </script>
</body>
</html>
